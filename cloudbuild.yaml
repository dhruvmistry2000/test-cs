substitutions:
  _IMAGE_NAME: 'dhruv-mistry-test'
  _CD_BRANCH: 'main'
  _GITHUB_USER: 'dhruvmistry2000'
  _GITHUB_USER_EMAIL: 'dhruvmistry2000@gmail.com'

steps:
  # Step 1: Check if only kube/deployment.yaml was changed
  - name: 'gcr.io/cloud-builders/git'
    id: 'check-diff'
    entrypoint: /bin/sh
    args:
      - '-c'
      - |
        echo "Checking changed files..."
        git fetch origin ${_CD_BRANCH}
        change_file=$(git diff --name-only HEAD~1 HEAD)

        echo "Changed files:"
        echo "$change_file_"

        # Check if only kube/deployment.yaml was changed
        if echo "$change_file_" | grep -qv "^kube/deployment.yaml$"; then
          echo "Other files changed — continuing build."
        else
          echo "Only kube/deployment.yaml changed — skipping build."
          exit 0
        fi

  # Step 2: Build the Docker image
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-image'
    waitFor: ['check-diff']
    args:
      - 'build'
      - '-t'
      - 'gcr.io/$PROJECT_ID/${_IMAGE_NAME}:$SHORT_SHA'
      - '.'

  # Step 3: Tag image as :latest
  - name: 'gcr.io/cloud-builders/docker'
    id: 'tag-for-latest'
    waitFor: ['build-image']
    args:
      - 'tag'
      - 'gcr.io/$PROJECT_ID/${_IMAGE_NAME}:$SHORT_SHA'
      - 'gcr.io/$PROJECT_ID/${_IMAGE_NAME}:latest'

  # Step 4: Push :short_sha tag
  - name: 'gcr.io/cloud-builders/docker'
    id: 'push-tag'
    waitFor: ['tag-for-latest']
    args:
      - 'push'
      - 'gcr.io/$PROJECT_ID/${_IMAGE_NAME}:$SHORT_SHA'

  # Step 5: Push :latest tag
  - name: 'gcr.io/cloud-builders/docker'
    id: 'push-latest'
    waitFor: ['push-tag']
    args:
      - 'push'
      - 'gcr.io/$PROJECT_ID/${_IMAGE_NAME}:latest'

  # Step 6: Update deployment.yaml and push back to GitHub
  - name: 'gcr.io/cloud-builders/gcloud'
    entrypoint: /bin/sh
    args:
      - '-c'
      - |
        git clone https://${_GITHUB_USER}:${_GIT_ACCESS_TOKEN}@github.com/${_GITHUB_USER}/test-cs -b ${_CD_BRANCH}
        echo "Updating image tag in deployment.yaml..."
        cd test-cs

        sed -i "s|\(^[[:space:]]*image: gcr.io/$PROJECT_ID/${_IMAGE_NAME}:\)[^[:space:]]*|\1$SHORT_SHA|" kube/deployment.yaml

        git config --global user.name "${_GITHUB_USER}"
        git config --global user.email "${_GITHUB_USER_EMAIL}"
        git add kube/deployment.yaml
        git commit -m "[Cloud Build] Updated image tag to $SHORT_SHA"
        git push https://${_GITHUB_USER}:${_GIT_ACCESS_TOKEN}@github.com/${_GITHUB_USER}/test-cs ${_CD_BRANCH}

# availableSecrets:
#   secretManager:
#     - versionName: projects/$PROJECT_NUMBER/secrets/github-access-token/versions/latest
#       env: 'GIT_ACCESS_TOKEN'

images:
  - 'gcr.io/$PROJECT_ID/${_IMAGE_NAME}:$SHORT_SHA'
  - 'gcr.io/$PROJECT_ID/${_IMAGE_NAME}:latest'

options:
  logging: CLOUD_LOGGING_ONLY
