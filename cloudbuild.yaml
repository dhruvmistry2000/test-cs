substitutions:
  _IMAGE_NAME: 'dhruv-mistry-test'

steps:
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-image'
    args:
      - 'build'
      - '-t'
      - 'gcr.io/$PROJECT_ID/${_IMAGE_NAME}:$BUILD_ID'
      - '.'

  - name: 'gcr.io/cloud-builders/docker'
    id: 'tag-for-latest'
    waitFor: ['build-image']
    args:
      - 'tag'
      - 'gcr.io/$PROJECT_ID/${_IMAGE_NAME}:$BUILD_ID'
      - 'gcr.io/$PROJECT_ID/${_IMAGE_NAME}:latest'

  - name: 'gcr.io/cloud-builders/docker'
    id: 'push-tag'
    waitFor: ['tag-for-latest']
    args:
      - 'push'
      - 'gcr.io/$PROJECT_ID/${_IMAGE_NAME}:$BUILD_ID'

  - name: 'gcr.io/cloud-builders/docker'
    id: 'push-latest'
    waitFor: ['push-tag']
    args:
      - 'push'
      - 'gcr.io/$PROJECT_ID/${_IMAGE_NAME}:latest'

  - name: 'gcr.io/cloud-builders/git'
    id: 'update-and-push-deployment'
    waitFor: ['push-latest']
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        set -euxo pipefail

        # Configure git identity
        git config --global user.email "cloudbuild@google.com"
        git config --global user.name "Cloud Build"

        # Modify the image tag in the manifest
        sed -i "s|^[[:space:]]*image: .*|        image: gcr.io/$PROJECT_ID/${_IMAGE_NAME}:$BUILD_ID|" kube/deployment.yaml

        git status
        git diff

        git add kube/deployment.yaml

        if ! git diff --cached --quiet; then
          git commit -m "Update deployment image to $BUILD_ID"
          
          # Use HTTPS remote URL with PAT embedded for authentication
          # Note: URL encoding '@' as '%40' if needed
          git remote set-url origin https://$_GITHUB_PAT@github.com/dhruvmistry2000/test-cs.git

          # Push commit
          git push origin HEAD
        else
          echo "No changes to commit"
        fi




images:
  - 'gcr.io/$PROJECT_ID/${_IMAGE_NAME}:$BUILD_ID'
  - 'gcr.io/$PROJECT_ID/${_IMAGE_NAME}:latest'

options:
  logging: CLOUD_LOGGING_ONLY
